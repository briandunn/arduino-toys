namespace :test do
  file 'gtest-all.o' => '../gtest/src/gtest-all.cc' do |t|
    sh "c++ -I../gtest -I../gtest/include -c #{t.prerequisites.first}"
  end

  file 'gtest_main.o' => '../gtest/src/gtest_main.cc' do |t|
    sh "c++ -I../gtest -I../gtest/include -c #{t.prerequisites.first}"
  end

  file 'gtest_main.a' => %w[gtest-all.o gtest_main.o] do |t|
    sh "ar -rv #{t.name} #{t.prerequisites.join ' '}"
  end

  file 'poll_button.o' => 'poll_button.cpp' do |t|
    sh "c++ -c #{t.prerequisites.first}"
  end

  file 'interrupt_button.o' => 'interrupt_button.cpp' do |t|
    sh "c++ -c -Itest #{t.prerequisites.first}"
  end

  file 'round_test.o' => 'test/round_test.cc' do |t|
    sh "c++ -c -I. -Itest -I../gtest/include #{t.prerequisites.first}"
  end

  file 'interrupt_button_test.o' => 'test/interrupt_button_test.cc' do |t|
    sh "c++ -c -I. -Itest -I../gtest/include #{t.prerequisites.first}"
  end

  file 'test/test' => %w[round_test.o interrupt_button_test.o interrupt_button.o poll_button.o gtest_main.a] do |t|
    sh "c++ -o #{t.name} #{t.prerequisites.join ' '}"
  end

  task all: "test/test" do |t|
    sh "./#{t.prerequisites.first}"
  end

  task :clean do
    sh "rm *.o test/test"
  end
end

task default: 'test:all'
