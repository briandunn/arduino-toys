namespace :test do
  file 'gtest-all.o' do
    sh "c++ -I../gtest -I../gtest/include -c ../gtest/src/gtest-all.cc"
  end

  file 'gtest_main.o' do
    sh "c++ -I../gtest -I../gtest/include -c ../gtest/src/gtest_main.cc"
  end

  file 'gtest_main.a' => %w[gtest-all.o gtest_main.o] do |t|
    sh "ar -rv #{t.name} #{t.prerequisites.join ' '}"
  end

  file 'poll_button.o' do
    sh "c++ -c poll_button.cpp"
  end

  file 'round_test.o' do
    sh "c++ -c -I. test/round_test.cc -I../gtest/include"
  end

  file 'interrupt_button.o' do
    sh "c++ -c -Itest interrupt_button.cpp"
  end

  file 'interrupt_button_test.o' do
    sh "c++ -c -I. -Itest test/interrupt_button_test.cc -I../gtest/include"
  end

  file 'test/test' => %w[round_test.o interrupt_button_test.o interrupt_button.o poll_button.o gtest_main.a] do |t|
    sh "c++ -o #{t.name} #{t.prerequisites.join ' '}"
  end

  task all: "test/test" do |t|
    sh "./#{t.prerequisites.first}"
  end

  task :clean do
    sh "rm *.o *.a test/test"
  end
end

task default: 'test:all'
